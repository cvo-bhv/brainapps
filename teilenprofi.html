import React, { useState, useEffect } from 'react';
import { Star, ArrowRight, RefreshCcw, Check, Heart, Trophy, Home, Calculator, Smile, HelpCircle, Hand } from 'lucide-react';

// --- Komponenten ---

/**
 * Ein interaktives Icon im iOS-Stil (Squircle mit Gradient).
 */
const AppIcon = ({ size = "large" }: { size?: "small" | "large" }) => {
  const isLarge = size === "large";
  return (
    <div className={`
      relative flex items-center justify-center
      bg-gradient-to-br from-sky-400 to-indigo-600
      shadow-xl overflow-hidden
      ${isLarge ? 'w-32 h-32 rounded-[22%] mb-6 border-4 border-white' : 'w-10 h-10 rounded-[22%]'}
    `}>
      {/* Hintergrund-Glanzeffekt */}
      <div className="absolute inset-0 bg-gradient-to-tr from-white/20 to-transparent pointer-events-none" />
      
      {/* Hauptsymbol: Divisionszeichen */}
      <div className={`font-black text-white drop-shadow-md select-none ${isLarge ? 'text-6xl' : 'text-2xl'}`}>
        :
      </div>

      {/* Kleine Akzente (Apfel & Stern) */}
      {isLarge && (
        <>
          <span className="absolute top-3 left-3 text-2xl rotate-[-15deg] drop-shadow-sm">üçé</span>
          <span className="absolute bottom-3 right-3 text-2xl rotate-[15deg] drop-shadow-sm">‚≠ê</span>
        </>
      )}
    </div>
  );
};

// --- Typen & Interfaces ---
type Difficulty = 'visual' | 'matching' | 'abstract' | null;

interface MathProblem {
  dividend: number;
  divisor: number;
  quotient: number;
  options?: number[];
  visualType?: 'apples' | 'cookies' | 'stars' | 'cakes' | 'money' | 'burgers';
}

// --- Hilfsfunktionen ---
const generateRandomInt = (min: number, max: number) => Math.floor(Math.random() * (max - min + 1)) + min;

const getVisualIcon = (type: string) => {
  switch (type) {
    case 'apples': return 'üçé';
    case 'cookies': return 'üç™';
    case 'stars': return '‚≠ê'; 
    case 'cakes': return 'üç∞'; 
    case 'money': return 'üí∞';
    case 'burgers': return 'üçî';
    default: return 'üü£';
  }
};

const motivationalPhrases = ["Super!", "Klasse!", "Richtig!", "Toll gemacht!", "Weiter so!"];

// --- Daten f√ºr die Container (STYLING ANGEPASST: Immer oben) ---
const CONTAINER_ASSETS = [
    { icon: 'üë∂', label: 'Kinder', styleClass: 'absolute -top-12 left-1/2 transform -translate-x-1/2 text-4xl' }, 
    { icon: 'üçΩÔ∏è', label: 'Teller', styleClass: 'absolute -top-12 left-1/2 transform -translate-x-1/2 text-4xl' },
    { icon: 'üß∫', label: 'K√∂rbe', styleClass: 'absolute -top-12 left-1/2 transform -translate-x-1/2 text-4xl' },
    { icon: 'üéÅ', label: 'Geschenkt√ºten', styleClass: 'absolute -top-12 left-1/2 transform -translate-x-1/2 text-4xl' },
    { icon: 'üóÑÔ∏è', label: 'F√§cher', styleClass: 'absolute -top-12 left-1/2 transform -translate-x-1/2 text-4xl' },
    { icon: 'ü™ô', label: 'Kassen', styleClass: 'absolute -top-12 left-1/2 transform -translate-x-1/2 text-4xl' },
];

export default function DivisionApp() {
  const [currentScreen, setCurrentScreen] = useState<'menu' | 'game'>('menu');
  const [difficulty, setDifficulty] = useState<Difficulty>(null);
  const [score, setScore] = useState(0);
  const [streak, setStreak] = useState(0);
  const [problem, setProblem] = useState<MathProblem | null>(null);
  const [feedback, setFeedback] = useState<'none' | 'success' | 'error'>('none');
  const [showHint, setShowHint] = useState(false); 
  const [distributedItems, setDistributedItems] = useState<number[]>([]);
  const [hintSolved, setHintSolved] = useState(false);

  const startGame = (level: Difficulty) => {
    setDifficulty(level);
    setScore(0);
    setStreak(0);
    setCurrentScreen('game');
    generateProblem(level);
  };

  const generateProblem = (level: Difficulty) => {
    setFeedback('none');
    setShowHint(false);
    setHintSolved(false);
    let newProblem: MathProblem;

    if (level === 'visual') {
      const divisor = generateRandomInt(2, 3);
      const quotient = generateRandomInt(2, 4); 
      const dividend = divisor * quotient;
      const itemTypes: MathProblem['visualType'][] = ['apples', 'cookies', 'stars', 'cakes', 'money', 'burgers'];
      
      newProblem = {
        dividend,
        divisor,
        quotient,
        visualType: itemTypes[generateRandomInt(0, itemTypes.length - 1)]
      };
      setDistributedItems(new Array(divisor).fill(0));

    } else if (level === 'matching') {
      const divisor = generateRandomInt(2, 5);
      const quotient = generateRandomInt(2, 6);
      const dividend = divisor * quotient;
      const correct = quotient;
      const options = [correct];
      while (options.length < 3) {
        let wrong = generateRandomInt(1, 10);
        if (!options.includes(wrong) && wrong !== correct) options.push(wrong);
      }
      options.sort(() => Math.random() - 0.5);
      newProblem = { dividend, divisor, quotient, options };
      setDistributedItems(new Array(divisor).fill(0));

    } else {
      const divisor = generateRandomInt(2, 9);
      const quotient = generateRandomInt(2, 10);
      const dividend = divisor * quotient;
      const hardProblems = [{d: 56, v: 8}, {d: 42, v: 7}, {d: 72, v: 9}, {d: 63, v: 7}, {d: 64, v: 8}, {d: 81, v: 9}];
      if (Math.random() > 0.6) {
        const hp = hardProblems[generateRandomInt(0, hardProblems.length - 1)];
        newProblem = { dividend: hp.d, divisor: hp.v, quotient: hp.d / hp.v };
      } else {
        newProblem = { dividend, divisor, quotient };
      }
    }
    setProblem(newProblem);
  };

  const handleLevel1Click = (bucketIndex: number) => {
    if (!problem || feedback === 'success') return;
    const totalDistributed = distributedItems.reduce((a, b) => a + b, 0);
    if (totalDistributed < problem.dividend) {
      const newItems = [...distributedItems];
      newItems[bucketIndex]++;
      setDistributedItems(newItems);
      if (totalDistributed + 1 === problem.dividend) {
        const isEqual = newItems.every(val => val === problem.quotient);
        if (isEqual) handleSuccess(); else setFeedback('error');
      }
    }
  };

  const handleHintClick = (bucketIndex: number) => {
    if (!problem || hintSolved) return;
    const totalDistributed = distributedItems.reduce((a, b) => a + b, 0);
    if (totalDistributed < problem.dividend) {
      const newItems = [...distributedItems];
      newItems[bucketIndex]++;
      setDistributedItems(newItems);
      if (totalDistributed + 1 === problem.dividend) {
        if (newItems.every(val => val === problem.quotient)) setHintSolved(true);
      }
    }
  };

  const resetDistribution = () => {
    if (problem) {
      setDistributedItems(new Array(problem.divisor).fill(0));
      setHintSolved(false);
    }
    setFeedback('none');
  };

  const handleAnswer = (answer: number) => {
    if (!problem) return;
    if (answer === problem.quotient) {
      handleSuccess();
    } else {
      setFeedback('error');
      if (!showHint) {
         setShowHint(true);
         setDistributedItems(new Array(problem.divisor).fill(0));
         setHintSolved(false);
      }
      setTimeout(() => setFeedback('none'), 1500);
    }
  };

  const handleSuccess = () => {
    setFeedback('success');
    const newScore = score + 1;
    setScore(newScore);
    const newStreak = streak + 1;
    setStreak(newStreak);
    const delay = difficulty === 'visual' ? 4000 : 2000;
    setTimeout(() => generateProblem(difficulty!), delay);
  };

  // --- Screens ---

  if (currentScreen === 'menu') {
    return (
      <div className="min-h-screen bg-sky-50 flex flex-col items-center justify-center p-4 font-sans">
        <div className="bg-white p-8 rounded-[32px] shadow-2xl max-w-md w-full text-center border-b-8 border-sky-200 flex flex-col items-center">
          
          {/* iOS Icon Platzierung */}
          <AppIcon />

          <h1 className="text-4xl font-extrabold text-sky-600 mb-2">Mathe-Meister</h1>
          <p className="text-gray-500 mb-8 text-lg">Division spielend lernen</p>

          <div className="space-y-4 w-full">
            <button 
              onClick={() => startGame('visual')}
              className="w-full bg-green-100 hover:bg-green-200 text-green-700 p-4 rounded-2xl flex items-center gap-4 transition-all hover:scale-[1.02] border-b-4 border-green-300 group"
            >
              <div className="bg-white p-2 rounded-full shadow-sm group-hover:scale-110 transition-transform text-2xl">üçé</div>
              <div className="text-left">
                <div className="font-bold text-xl">Gerecht verteilen</div>
                <div className="text-sm opacity-70">Ganz leicht mit Bildern</div>
              </div>
              <ArrowRight className="ml-auto" />
            </button>

            <button 
              onClick={() => startGame('matching')}
              className="w-full bg-yellow-100 hover:bg-yellow-200 text-yellow-800 p-4 rounded-2xl flex items-center gap-4 transition-all hover:scale-[1.02] border-b-4 border-yellow-300 group"
            >
              <div className="bg-white p-2 rounded-full shadow-sm group-hover:scale-110 transition-transform"><HelpCircle className="text-yellow-500" size={24} /></div>
              <div className="text-left">
                <div className="font-bold text-xl">Welche Zahl passt?</div>
                <div className="text-sm opacity-70">Interaktives Zuordnen</div>
              </div>
              <ArrowRight className="ml-auto" />
            </button>

            <button 
              onClick={() => startGame('abstract')}
              className="w-full bg-indigo-100 hover:bg-indigo-200 text-indigo-700 p-4 rounded-2xl flex items-center gap-4 transition-all hover:scale-[1.02] border-b-4 border-indigo-300 group"
            >
               <div className="bg-white p-2 rounded-full shadow-sm group-hover:scale-110 transition-transform"><Calculator className="text-indigo-500" size={24} /></div>
               <div className="text-left">
                <div className="font-bold text-xl">Rechnen Profi</div>
                <div className="text-sm opacity-70">Das kleine Einmaleins</div>
              </div>
              <ArrowRight className="ml-auto" />
            </button>
          </div>
        </div>
      </div>
    );
  }

  const LevelVisual = () => {
    if (!problem) return null;
    const itemsLeft = problem.dividend - distributedItems.reduce((a, b) => a + b, 0);
    const icon = getVisualIcon(problem.visualType || 'apples');
    const containerType = CONTAINER_ASSETS[(problem.dividend * problem.divisor) % CONTAINER_ASSETS.length];

    return (
      <div className="flex flex-col items-center w-full max-w-2xl">
        <h2 className="text-2xl font-bold text-blue-600 mb-4 text-center">Verteile gerecht!</h2>
        <div className="text-xl mb-4 text-gray-700 bg-white px-4 py-2 rounded-xl shadow-sm text-center">
          Wir haben <span className="font-bold text-3xl mx-1 text-pink-500">{problem.dividend}</span> {icon} 
          <br/>f√ºr <span className="font-bold text-3xl mx-1 text-blue-500">{problem.divisor}</span> {containerType.label}.
        </div>
        <div className="bg-pink-100 p-4 rounded-3xl min-h-[100px] w-full flex flex-wrap justify-center gap-2 mb-6 shadow-inner border-4 border-pink-200">
          {Array.from({ length: itemsLeft }).map((_, i) => <span key={i} className="text-4xl animate-bounce" style={{animationDelay: `${i * 0.1}s`}}>{icon}</span>)}
          {itemsLeft === 0 && <span className="text-gray-400 font-bold italic">Alle verteilt!</span>}
        </div>
        <div className="flex flex-wrap justify-center gap-x-4 gap-y-16 w-full pt-8"> {/* pt-8 und gap-y-16 f√ºr Platz oben */}
          {distributedItems.map((count, idx) => (
            <button key={idx} onClick={() => handleLevel1Click(idx)} className={`relative w-32 h-32 md:w-40 md:h-40 bg-white rounded-full border-4 flex flex-wrap content-center justify-center p-2 gap-1 transition-all transform active:scale-95 ${feedback === 'error' ? 'border-red-400 bg-red-50' : 'border-blue-300 hover:border-blue-500'}`}>
              <div className={containerType.styleClass}>{containerType.icon}</div> 
              {Array.from({ length: count }).map((_, i) => <span key={i} className="text-2xl relative z-10">{icon}</span>)}
            </button>
          ))}
        </div>
        {feedback === 'error' && (
           <div className="mt-4 flex flex-col items-center animate-pulse">
             <p className="text-red-500 font-bold text-lg mb-2">Das ist nicht gerecht! Einer hat mehr.</p>
             <button onClick={resetDistribution} className="bg-orange-400 text-white px-6 py-2 rounded-full font-bold shadow-lg hover:bg-orange-500 flex items-center gap-2"><RefreshCcw size={20} /> Noch mal versuchen</button>
           </div>
        )}
      </div>
    );
  };

  const LevelMatching = () => {
    if (!problem) return null;
    const hintItemsLeft = problem.dividend - distributedItems.reduce((a, b) => a + b, 0);
    const hintTotalDistributed = distributedItems.reduce((a, b) => a + b, 0);
    const hintError = hintTotalDistributed === problem.dividend && !hintSolved;
    const isLocked = showHint && !hintSolved;
    const containerType = problem ? CONTAINER_ASSETS[(problem.dividend * problem.divisor) % CONTAINER_ASSETS.length] : null;

    return (
      <div className="flex flex-col items-center w-full max-w-xl">
        <h2 className="text-2xl font-bold text-purple-600 mb-6 text-center">Welche Antwort passt?</h2>
        <div className="flex items-center justify-center gap-4 text-5xl md:text-7xl font-bold text-gray-800 bg-white p-8 rounded-3xl shadow-lg border-b-8 border-gray-200 mb-8 w-full">
          <span className="text-purple-600">{problem.dividend}</span>
          <span className="text-gray-400">:</span>
          <span className="text-blue-500">{problem.divisor}</span>
          <span className="text-gray-400">=</span>
          <div className="w-16 h-16 md:w-20 md:h-20 bg-gray-100 rounded-xl border-2 border-dashed border-gray-400 flex items-center justify-center"><span className="text-4xl text-gray-400">?</span></div>
        </div>
        <div className="grid grid-cols-3 gap-4 w-full">
          {problem.options?.map((opt, idx) => {
            let btnStyle = "bg-yellow-100 hover:bg-yellow-200 border-yellow-300 text-yellow-800";
            if (isLocked) btnStyle = "bg-gray-100 border-gray-300 text-gray-300 cursor-not-allowed opacity-50";
            else if (hintSolved && opt === problem.quotient) btnStyle = "bg-green-100 border-green-400 text-green-700 animate-pulse ring-4 ring-green-300";
            return (
              <button key={idx} onClick={() => handleAnswer(opt)} disabled={isLocked} className={`border-b-4 rounded-2xl py-6 text-4xl font-bold transition-transform transform shadow-md ${btnStyle} ${!isLocked ? 'active:scale-95' : ''}`}>{opt}</button>
            )
          })}
        </div>
        {showHint && (
          <div className="mt-8 w-full bg-orange-50 p-6 rounded-3xl border-4 border-orange-300 shadow-xl animate-in fade-in slide-in-from-bottom-4 relative overflow-hidden">
            <div className="relative z-10 text-center mb-6">
                <h3 className="text-xl md:text-2xl font-extrabold text-orange-800 mb-3 leading-relaxed">Wie oft passt die <span className="inline-block bg-white text-blue-600 px-3 py-1 rounded-xl border-2 border-blue-200 mx-1 shadow-sm">{problem.divisor}</span> in die <span className="inline-block bg-white text-purple-600 px-3 py-1 rounded-xl border-2 border-purple-200 mx-1 shadow-sm">{problem.dividend}</span>?</h3>
                <div className="flex items-center justify-center gap-2 text-orange-700 font-bold text-lg bg-white/60 py-2 px-4 rounded-xl inline-flex"><Hand size={24} className={isLocked ? "animate-bounce" : ""} /><p>{isLocked ? "Probier es aus: Verteile die Punkte!" : "Super! W√§hle jetzt oben die Antwort:"}</p></div>
            </div>
            {!hintSolved && (
              <div className="flex flex-wrap justify-center gap-1 mb-4 bg-white p-3 rounded-2xl min-h-[40px] border-2 border-orange-100 shadow-inner">
                {Array.from({ length: hintItemsLeft }).map((_, i) => <div key={i} className="w-5 h-5 bg-purple-500 rounded-full shadow-sm border border-purple-600"></div>)}
                {hintItemsLeft === 0 && !hintSolved && <span className="text-xs text-gray-400 font-bold self-center">Alle verteilt</span>}
              </div>
            )}
            <div className="flex flex-wrap justify-center gap-x-3 gap-y-12 pt-8 relative z-10"> {/* gap-y-12 f√ºr Platz der Icons */}
              {distributedItems.map((count, idx) => (
                <button key={idx} onClick={() => handleHintClick(idx)} disabled={hintSolved || hintItemsLeft === 0} className={`relative border-4 border-dashed rounded-full w-24 h-24 flex flex-wrap justify-center items-center content-center gap-1 transition-all transform hover:scale-105 active:scale-95 ${hintError ? 'border-red-400 bg-red-50' : 'border-orange-200 bg-white hover:border-orange-400'} ${hintSolved ? 'border-green-500 bg-green-50 scale-105 ring-4 ring-green-200 border-solid' : ''}`}>
                   {containerType && <div className={containerType.styleClass}>{containerType.icon}</div>}
                   {Array.from({ length: count }).map((_, j) => <div key={j} className="w-3 h-3 bg-blue-500 rounded-full shadow-sm"></div>)}
                </button>
              ))}
            </div>
            {hintError && (
               <div className="text-center mt-3 bg-red-100 text-red-600 px-4 py-2 rounded-xl inline-block font-bold border border-red-200 animate-pulse"><p className="text-sm text-center">Das ist nicht gleichm√§√üig!</p><button onClick={resetDistribution} className="mt-1 text-xs underline hover:text-red-800">Nochmal</button></div>
            )}
            {hintSolved && (
               <div className="text-center mt-6 bg-green-100 p-4 rounded-2xl border-2 border-green-400 shadow-md animate-bounce"><p className="text-green-800 font-bold text-lg mb-1">Siehst du?</p><p className="text-green-700">In jedem Kreis sind <span className="text-2xl font-black">{problem.quotient}</span> Punkte.</p></div>
            )}
          </div>
        )}
        {!showHint && <div className="mt-8 opacity-70"><p className="text-center text-gray-500 mb-2 text-sm italic">Tipp: Wie oft musst du die {problem.divisor} zusammenrechnen, um auf {problem.dividend} zu kommen?</p></div>}
      </div>
    );
  };

  const LevelAbstract = () => {
    if (!problem) return null;
    const [input, setInput] = useState('');
    const handleNumPad = (n: number) => input.length < 3 && setInput(prev => prev + n);
    const checkInput = () => { if (parseInt(input) === problem.quotient) handleAnswer(problem.quotient); else setFeedback('error'); setInput(''); };
    return (
      <div className="flex flex-col items-center w-full max-w-md">
        <div className="bg-indigo-600 text-white w-full py-8 rounded-t-3xl rounded-b-lg shadow-lg flex justify-center items-center gap-3 text-5xl md:text-6xl font-bold mb-6">
          <span>{problem.dividend}</span><span className="text-indigo-300">:</span><span>{problem.divisor}</span><span>=</span><span className="border-b-4 border-white min-w-[60px] text-center inline-block h-[70px]">{input}</span>
        </div>
        <div className="grid grid-cols-3 gap-3 w-full bg-gray-100 p-4 rounded-3xl">
          {[1, 2, 3, 4, 5, 6, 7, 8, 9].map(n => <button key={n} onClick={() => handleNumPad(n)} className="bg-white p-4 rounded-xl shadow-sm text-3xl font-bold text-gray-700 active:bg-gray-50">{n}</button>)}
          <button onClick={() => setInput(prev => prev.slice(0, -1))} className="bg-red-100 text-red-500 p-4 rounded-xl shadow-sm font-bold">C</button>
          <button onClick={() => handleNumPad(0)} className="bg-white p-4 rounded-xl shadow-sm text-3xl font-bold text-gray-700">0</button>
          <button onClick={checkInput} className="bg-green-500 text-white p-4 rounded-xl shadow-md text-2xl font-bold active:bg-green-600">OK</button>
        </div>
      </div>
    );
  };

  return (
    <div className="min-h-screen bg-slate-100 flex flex-col items-center p-4 font-sans relative overflow-hidden">
      <div className="w-full max-w-4xl flex justify-between items-center mb-8 bg-white p-4 rounded-2xl shadow-sm border-b-4 border-slate-200 z-10">
        <button onClick={() => setCurrentScreen('menu')} className="p-2 hover:bg-gray-100 rounded-xl text-gray-500 flex items-center gap-2 font-bold"><Home size={24} /> <span className="hidden md:inline">Men√º</span></button>
        <div className="flex gap-2 bg-yellow-100 px-4 py-2 rounded-full border-2 border-yellow-200"><Star className="text-yellow-500 fill-yellow-500" /><span className="font-bold text-yellow-700">{score} Sterne</span></div>
      </div>
      <div className="flex-grow flex flex-col items-center justify-center w-full relative z-10">
        {feedback === 'success' && (
          <div className="absolute inset-0 flex flex-col items-center justify-center bg-white/90 z-50 backdrop-blur-sm animate-in fade-in duration-300 rounded-3xl">
            <div className="text-8xl mb-4 animate-bounce">üåü</div>
            <h2 className="text-4xl font-extrabold text-green-500 mb-2">{motivationalPhrases[Math.floor(Math.random() * motivationalPhrases.length)]}</h2>
            {difficulty === 'visual' && problem && (
               <div className="mt-6 bg-blue-50 px-8 py-4 rounded-2xl border-4 border-blue-200 shadow-lg animate-in zoom-in duration-500">
                  <p className="text-gray-500 font-bold mb-2 text-center text-sm uppercase tracking-wide italic">Gelernt:</p>
                  <div className="flex items-center justify-center gap-3 text-5xl font-bold text-gray-800">
                     <span className="text-pink-500">{problem.dividend}</span><span className="text-gray-400">:</span><span className="text-blue-500">{problem.divisor}</span><span className="text-gray-400">=</span><span className="text-green-600">{problem.quotient}</span>
                  </div>
               </div>
            )}
            <p className="text-gray-500 font-bold mt-8">Gleich geht's weiter...</p>
          </div>
        )}
        {difficulty === 'visual' && <LevelVisual />}
        {difficulty === 'matching' && <LevelMatching />}
        {difficulty === 'abstract' && <LevelAbstract />}
      </div>
      <div className="mt-8 text-center text-gray-400 text-sm italic">{streak > 2 && <div className="mb-2 text-orange-500 font-bold flex items-center justify-center gap-2 animate-pulse"><Trophy size={16}/> {streak} Aufgaben hintereinander richtig!</div>}</div>
      <div className="absolute top-20 left-10 text-9xl opacity-5 pointer-events-none rotate-12 select-none">‚ûó</div>
      <div className="absolute bottom-20 right-10 text-9xl opacity-5 pointer-events-none -rotate-12 select-none">üçî</div>
    </div>
  );
}
